# Принципы и архитектура Apache Kafka

## Основная идея
- Kafka — распределённый commit log, к которому клиенты читают и пишут в порядке записи.
- События неизменяемы: данные только добавляются, что упрощает масштабирование и повторное чтение.

## Ключевые компоненты
| Компонент | Роль |
|-----------|------|
| **Broker** | Процесс, принимающий записи и обслуживающий клиентов; несколько брокеров образуют кластер. |
| **Topic** | Логическая шина событий. Делится на партиции для параллелизма. |
| **Partition** | Последовательность записей с упорядоченными смещениями (offset). |
| **Producer** | Клиент, отправляющий сообщения в топики. |
| **Consumer** | Клиент, читающий сообщения из топиков. Может объединяться в consumer group. |
| **ZooKeeper/KRaft** | Компонент управления метаданными (ZooKeeper в старых версиях, KRaft — встроенный consensus). |

## Жизненный цикл сообщения
1. Producer сериализует событие и отправляет его в брокер.
2. Брокер записывает событие в лог партиции, подтверждает запись в зависимости от настроек `acks`.
3. Consumer считывает сообщения по смещениям, фиксирует прогресс (offset commit) и обрабатывает событие.
4. Хранение сообщений контролируется политиками ретенции (по времени или размеру).

## Основные принципы масштабирования
- **Горизонтальное масштабирование** достигается добавлением брокеров и партиций.
- **Балансировка нагрузки** строится вокруг ключей сообщений (partition key) и consumer group.
- **Долговечность** обеспечивается репликацией партиций и синхронными подтверждениями.

## Модели доставки
- At-most-once: подтверждаем до обработки, минимизируем дубликаты, возможна потеря.
- At-least-once: подтверждаем после обработки, исключаем потерю, возможны дубликаты.
- Exactly-once: используем idempotent producers и транзакционные consumer'ы.
