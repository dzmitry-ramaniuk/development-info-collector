# Архитектура и внутреннее устройство PostgreSQL


## Содержание

1. [1. Основные процессы и службы](#1-основные-процессы-и-службы)
2. [2. Память и кэширование](#2-память-и-кэширование)
3. [3. Хранение данных](#3-хранение-данных)
4. [4. WAL и восстановление](#4-wal-и-восстановление)
5. [5. MVCC и управление версиями](#5-mvcc-и-управление-версиями)
6. [6. Система каталогов и метаданные](#6-система-каталогов-и-метаданные)
7. [7. Расширяемость и модульность](#7-расширяемость-и-модульность)
8. [8. Жизненный цикл запроса](#8-жизненный-цикл-запроса)
9. [9. Управление ресурсами и подключения](#9-управление-ресурсами-и-подключения)
10. [10. Безопасность и контроль доступа](#10-безопасность-и-контроль-доступа)
11. [11. Контроль состояния и диагностика](#11-контроль-состояния-и-диагностика)

## 1. Основные процессы и службы
- **Postmaster (`postgres`)** — главный процесс, который принимает подключения, поднимает серверные процессы и следит за аварийными ситуациями. При сбое backend-процесса postmaster инициирует восстановление.
- **Backend-процессы** — отдельные процессы на каждое подключение. Они выполняют парсинг, планирование и исполнение SQL, взаимодействуют с буферным кешем и механизмами блокировок.
- **Фоновые процессы**:
  - `checkpointer` сбрасывает грязные страницы на диск и создаёт контрольные точки.
  - `bgwriter` распределяет запись страниц, чтобы сократить всплески IO.
  - `walwriter` отвечает за своевременную запись WAL.
  - `autovacuum launcher/workers` выполняют очистку и анализ таблиц.
  - `logical replication launcher` и воркеры — обслуживают публикации/подписки логической репликации.
  - `archiver`, `stats collector`, `walreceiver`, `parallel workers` — вспомогательные службы для архивации, статистики, репликации и параллелизма.

## 2. Память и кэширование
- **Shared Buffers** — основной буферный пул. Размер настраивается `shared_buffers`; рекомендуется 20–30% RAM для OLTP.
- **WAL Buffers** — кольцевой буфер для WAL; значение `wal_buffers` влияет на скорость записи при высоких нагрузках.
- **Work Memory** — `work_mem` выделяется на *каждый узел плана* и на *каждый параллельный воркер*. Следите за суммарным потреблением памяти при сложных запросах.
- **Maintenance Work Memory** — `maintenance_work_mem` используется для `VACUUM`, `CREATE INDEX`, `ALTER TABLE ADD FOREIGN KEY`.
- **Temp Buffers** — `temp_buffers` для временных таблиц в рамках сессии.
- **Оптимизация OS cache** — параметр `effective_cache_size` помогает планировщику учитывать системный кеш файлов.

## 3. Хранение данных
- **Файловая организация**: каталог `PGDATA` содержит `base/` (таблицы), `global/` (глобальные каталоги), `pg_wal/` (WAL), `pg_tblspc/` (табличные пространства), `pg_stat/`, `pg_logical/` и др.
- **Страницы и сегменты**: страницы по 8 КБ, сегменты по 1 ГБ. При заполнении сегменты создаются автоматически.
- **TOAST**: большие значения (обычно > 2 КБ) переносятся в TOAST-таблицы. Настройка `ALTER TABLE ... SET STORAGE (EXTERNAL/MAIN/PLAIN)` управляет стратегией хранения.
- **FSM и Visibility Map**: помогают `VACUUM` и планировщику находить свободные и «чистые» страницы.
- **Табличные пространства**: `CREATE TABLESPACE` позволяет размещать объекты на разных дисках.

## 4. WAL и восстановление
- **Write-Ahead Logging** гарантирует долговечность: изменения сначала пишутся в журнал, затем в основное хранилище.
- **Контрольные точки** (`checkpoint_timeout`, `max_wal_size`, `checkpoint_completion_target`) определяют частоту и длительность сбросов.
- **Архивация**: `archive_mode=on`, `archive_command` копирует WAL на внешнее хранилище; используется для PITR.
- **Синхронизация записи**: `synchronous_commit` и `commit_delay` позволяют балансировать задержки и долговечность.

## 5. MVCC и управление версиями
- **Transaction ID (XID)** — 32-битный счётчик. Wraparound предотвращается `autovacuum_freeze_max_age` и `VACUUM FREEZE`.
- **xmin/xmax** в каждой строке описывают, кем и когда создана или удалена версия.
- **Hot Updates** — при изменении неиндексируемых столбцов запись может обновиться без обновления индексов.
- **Visibility Map** — отмечает страницы без мёртвых строк, позволяя `Index Only Scan` обходиться без чтения heap.
- **Снимки (snapshots)** — backend формирует снимок видимых транзакций при каждом запросе или `BEGIN` в зависимости от уровня изоляции.

## 6. Система каталогов и метаданные
- **`pg_catalog`** — таблицы с описанием объектов: `pg_class` (отношения), `pg_attribute` (столбцы), `pg_index`, `pg_constraint`.
- **`information_schema`** — стандартизированные представления SQL.
- **`pg_stat_*`** — статистические представления; включайте `track_counts`, `track_activities` для полноты данных.
- **Расширение `pgstattuple`, `pg_visibility`** — диагностика видимости и плотности страниц.

## 7. Расширяемость и модульность
- **Расширения** (`CREATE EXTENSION`) добавляют типы, функции, индексы. Популярные: `pg_stat_statements`, `citext`, `hstore`, `postgis`, `pg_partman`, `hypopg`.
- **Пользовательские типы и операторы**: PostgreSQL позволяет создавать домены, композитные типы, кастомные операторы и операторные классы.
- **Языки процедур**: помимо SQL и PL/pgSQL, доступны PL/Python, PL/Perl, PL/Java и др. Настраиваются через `CREATE LANGUAGE` или расширения.
- **Форматы хранения**: FDW (Foreign Data Wrapper) подключает внешние источники (PostgreSQL, Oracle, Kafka, файлы).

## 8. Жизненный цикл запроса
1. **Аутентификация** — проверка по `pg_hba.conf`, параметрам SSL, политике RLS.
2. **Парсинг и синтаксический анализ** — проверка структуры SQL.
3. **Переписывание** — применение правил и представлений.
4. **Оптимизация** — планировщик строит альтернативные планы, используя статистику (`pg_statistic`, `extended statistics`).
5. **Исполнение** — executor выполняет план, обращаясь к буферному кешу, индексу, RLS, блокировкам.
6. **Возврат данных** — backend отправляет результат, обновляет статистику и ждёт следующий запрос.
7. **Логирование** — в зависимости от настроек (`log_statement`, `log_min_duration_statement`) запрос фиксируется в логах.

## 9. Управление ресурсами и подключения
- **Параметры подключения**: `max_connections`, `superuser_reserved_connections`, `listen_addresses`.
- **Пулы соединений**: `pgBouncer`, `Pgpool-II`, встроенные logical replication slots — снижают overhead процессов.
- **Resource groups/queues** — через расширение `pg_stat_statements`, утилиты `pg_qualstats`, `pg_hint_plan` позволяют тонко управлять планами.
- **Лимиты использования**: `statement_timeout`, `idle_in_transaction_session_timeout`, `lock_timeout` защищают от зависаний.
- **Распределение фоновых рабочих**: `max_worker_processes`, `max_parallel_workers`, `max_parallel_maintenance_workers`.

## 10. Безопасность и контроль доступа
- **Роли и права**: наследование ролей (`IN ROLE`, `INHERIT`), использование групповых ролей.
- **Политики Row-Level Security**: гибкая фильтрация строк на уровне сервера.
- **Аудит**: `pgaudit`, `log_connections`, `log_disconnections`, `log_line_prefix` для трассировки действий.
- **Шифрование**: SSL/TLS (`ssl=on`), поддержка TLS 1.2+, настройка `ssl_ciphers`, шифрование данных на уровне файловой системы (`pgcrypto`, TDE в сторонних патчах).

## 11. Контроль состояния и диагностика
- **Внутренние счетчики**: `pg_stat_activity`, `pg_stat_database`, `pg_stat_bgwriter`, `pg_stat_wal`.
- **Wait Events**: `wait_event_type`, `wait_event` показывают, на чём «спит» процесс (IO, LWLock, Lock, Extension).
- **Журналы**: анализ логов `postgresql.log`, использование `pgBadger`.
- **Метрики**: интеграция с Prometheus через `postgres_exporter`, сбор детальных показателей по latency, блокировкам, размеру WAL.

Эти базовые знания по архитектуре помогают понимать поведение PostgreSQL под нагрузкой, правильно настраивать ресурсы и интерпретировать диагностические показатели.
