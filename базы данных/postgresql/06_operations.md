# Эксплуатация, резервное копирование и масштабирование PostgreSQL

## 1. Управление конфигурацией
- **Файлы настроек**: `postgresql.conf`, `pg_hba.conf`, `pg_ident.conf`. Используйте `ALTER SYSTEM` для программного изменения параметров и `SELECT pg_reload_conf();` для применения.
- **Точки контроля изменений**: храните конфигурацию в git, используйте `include_dir` для окружений (dev, stage, prod).
- **Параметры запуска**: `shared_buffers`, `work_mem`, `maintenance_work_mem`, `effective_cache_size`, `wal_level`, `max_connections`, `checkpoint_timeout` — база для тюнинга.
- **Профили нагрузок**: для OLTP — высокая конкурентность, минимальные задержки; для OLAP — долгие запросы, крупные `work_mem` и параллелизм.

## 2. Резервное копирование
### 2.1 Логические бэкапы
- `pg_dump` — экспорт схемы и данных. Режимы: `-Fc` (custom), `-Fd` (directory), `-Fp` (plain SQL).
- `pg_dumpall` — весь кластер (роли, конфигурация). Удобно для миграций и обновлений.
- `pg_restore --jobs=N` ускоряет восстановление параллельной загрузкой.
- Подходит для выборочного восстановления объектов и изменения структуры.

### 2.2 Физические бэкапы
- `pg_basebackup` — потоковое копирование каталога `PGDATA`. Используйте `--wal-method=stream` или архив WAL.
- Снимки файловой системы (LVM, ZFS, EBS) при остановленном или замороженном сервере.
- Инструменты: `pg_probackup`, `barman`, `wal-g` поддерживают инкрементальные копии, дедупликацию, шифрование, отправку в S3.

### 2.3 Point-In-Time Recovery (PITR)
- Сочетание базового бэкапа и архивированных WAL позволяет восстановиться к конкретному моменту (`recovery_target_time`, `recovery_target_xid`, `recovery_target_lsn`).
- Процесс: развернуть бэкап → настроить `restore_command` → создать `recovery.signal` (или `standby.signal` для реплики) → запустить сервер.
- После восстановления проверьте `pg_last_wal_replay_lsn` и синхронизацию с основным сервером.

## 3. Репликация и отказоустойчивость
- **Физическая репликация**: `wal_level=replica`, `max_wal_senders`, `hot_standby=on`. Реплика подключается через `primary_conninfo`.
- **Синхронная репликация**: гарантирует отсутствие потерь, но увеличивает задержку. Настраивается `synchronous_standby_names`.
- **Логическая репликация**: публикации (`CREATE PUBLICATION`) и подписки (`CREATE SUBSCRIPTION`). Поддерживает выборочные таблицы и версионные обновления.
- **Слоты репликации**: удерживают WAL, пока реплика не применит изменения. Следите за размером `pg_wal`.
- **Failover**: автоматизация с помощью Patroni, repmgr, Pacemaker. Тестируйте сценарии переключения.
- **Cascade replication**: реплика может стать источником для других реплик, разгружая основной сервер.

## 4. Масштабирование и высокодоступные топологии
- **Горизонтальное масштабирование**: распределяйте чтение по репликам, учитывая задержку (`pg_stat_replication` → `write_lag`, `replay_lag`).
- **Шардирование**: Citus, Postgres-XL, pg_shard или самостоятельное разделение по ключу. Требует мониторинга распределённых транзакций.
- **Прокси и балансировка**: HAProxy, Pgpool-II, Odyssey управляют маршрутами запросов.
- **Федерация данных**: FDW (`postgres_fdw`, `mysql_fdw`, `file_fdw`) — подключение внешних источников.
- **Connection pooling**: `pgBouncer` (режим transaction, session, statement) уменьшает накладные расходы на процессы.

## 5. Обслуживание и автоматизация
- **Autovacuum**: настройте `autovacuum_vacuum_threshold`, `autovacuum_vacuum_scale_factor`, `autovacuum_analyze_scale_factor`. Для горячих таблиц задавайте параметры на уровне таблицы (`ALTER TABLE ... SET (autovacuum_enabled = false)` и управляйте вручную).
- **PLAN**: регулярный `VACUUM (ANALYZE)` после массовых операций, `REINDEX` при bloat.
- **Регламентные задачи**: `cron`, `pg_cron`, `pgAgent` для плановых работ (бэкапы, анализ, отчёты).
- **Обновление статистики**: `ANALYZE`, `ALTER TABLE ... SET STATISTICS`, расширение `auto_explain` для анализа тяжёлых запросов.
- **Мониторинг диска**: `pg_tablespace_size`, `pg_total_relation_size`, `pgstattuple` для оценки плотности данных.

## 6. Настройка производительности
- **Память**: баланс между `shared_buffers` и потребностями ОС. `work_mem` учитывает количество параллельных запросов.
- **IO**: `effective_io_concurrency`, `random_page_cost`, `seq_page_cost` — адаптируйте под тип хранилища (SSD vs HDD).
- **WAL и контрольные точки**: `max_wal_size`, `checkpoint_timeout`, `checkpoint_completion_target`, `wal_compression`, `wal_writer_delay`.
- **Параллелизм**: `max_worker_processes`, `max_parallel_workers_per_gather`, `parallel_leader_participation`.
- **Логирование**: `log_checkpoints`, `log_lock_waits`, `log_temp_files`, `log_autovacuum_min_duration`.
- **Параметры для OLAP**: увеличенные `work_mem`, `temp_file_limit`, использование `parallel query`.

## 7. Безопасность и соответствие требованиям
- **Контроль доступа**: роли, `GRANT`/`REVOKE`, схемы для разделения объектов.
- **Аутентификация**: `md5`, `scram-sha-256`, `gss`, `ldap`, `cert`. Поддержка SSL и клиентских сертификатов.
- **Шифрование**: включение SSL, шифрование резервных копий (`wal-g`, `pg_probackup`), шифрование на уровне файловой системы.
- **Аудит**: расширение `pgaudit`, логирование DDL, хранение логов в централизованной системе.
- **Политики соответствия**: `Row-Level Security`, маскирование данных (`pg_mask`), контроль времени жизни паролей.

## 8. Миграции и обновления
- **Минорные обновления**: требуют рестарта, но совместимы по данным. Планируйте окна обслуживания.
- **Мажорные обновления**: `pg_upgrade` (in-place, требует совместимости каталогов) или логическая репликация на новый кластер.
- **Проверка совместимости**: `pg_upgrade --check`, `pg_dump --schema-only`, тестовые стенды.
- **Согласованность схемы**: используйте миграционные инструменты (`Liquibase`, `Flyway`, `Sqitch`).
- **Тестирование**: прогон нагрузочного теста, проверка планов, оценка времени восстановления.

## 9. Мониторинг и алертинг
- **Метрики**: CPU, RAM, IO, размер WAL, число соединений, долгие транзакции.
- **Инструменты**: Prometheus + Grafana, Zabbix, VictoriaMetrics, ELK.
- **Алерты**: превышение `max_connections`, рост `pg_xact`, задержка репликации, заполнение диска.
- **Отчётность**: `pgBadger`, `pganalyze`, `PoWA` для анализа исторических данных.
- **Логирование ошибок**: `log_error_verbosity`, `log_min_error_statement`, `log_parameter_max_length`.

Комплексная стратегия эксплуатации включает регулярные бэкапы, мониторинг, настройку производительности и планирование обновлений, что обеспечивает стабильную и безопасную работу PostgreSQL.
