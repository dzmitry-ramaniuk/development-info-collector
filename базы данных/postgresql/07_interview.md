# Вопросы и ответы для собеседований по PostgreSQL

## 1. Архитектура и хранение
1. **Как PostgreSQL реализует MVCC и зачем нужен VACUUM?**
   - MVCC хранит несколько версий строк с `xmin/xmax`, позволяя чтениям не блокировать записи. `VACUUM` удаляет невидимые версии, предотвращает рост файлов и wraparound XID.
2. **Что такое WAL и как он используется при восстановлении?**
   - WAL фиксирует все изменения до записи на диск. При сбое сервер воспроизводит журнал, чтобы восстановить согласованное состояние; WAL используется для репликации и PITR.
3. **Опишите структуру каталога `PGDATA`.**
   - `base/` — данные баз, `global/` — глобальные каталоги, `pg_wal/` — журнал, `pg_tblspc/` — табличные пространства, `pg_stat/` и `pg_logical/` — статистика и логическая репликация.

## 2. Типы данных и моделирование
4. **Чем отличаются `json` и `jsonb`?**
   - `json` хранится в текстовом виде и требует повторного парсинга; `jsonb` — бинарное представление, поддерживает индексы GIN, `jsonpath`, операторы сравнения и не сохраняет дубликаты ключей.
5. **Когда выбирать `BRIN`-индекс?**
   - Для больших таблиц, где значения коррелируют с физическим порядком (логи, временные ряды). Индекс занимает мало места и ускоряет диапазонные запросы.
6. **Как выбрать тип для денежных значений?**
   - Использовать `numeric(p, s)` для точности, избегать `float`. Дополнительно можно применять домены для контроля валюты.

## 3. Запросы и планы
7. **Что показывает `EXPLAIN (ANALYZE, BUFFERS)`?**
   - План с фактическим временем, количеством строк и статистикой буферов (`shared hit/read`, `temp read/write`), что помогает выявлять IO-узкие места.
8. **Когда использовать материализованные представления?**
   - Для тяжёлых отчётов, которые обновляются реже, чем читаются. `REFRESH MATERIALIZED VIEW` поддерживает актуальность, `CONCURRENTLY` минимизирует простой.
9. **Какие wait events указывают на проблемы с диском?**
   - `IO`, `DataFileRead`, `DataFileWrite`, `BufferIO` — признаки, что процессы ждут IO. Анализируйте `pg_stat_activity`, системные метрики.

## 4. Транзакции и блокировки
10. **Чем отличаются `REPEATABLE READ` и `SERIALIZABLE`?**
    - REPEATABLE READ фиксирует снимок, предотвращает неповторяющиеся чтения. SERIALIZABLE использует SSI, отслеживает опасные конфликты и может отклонить транзакцию, требуя повторного запуска.
11. **Как обнаружить и расследовать блокировки?**
    - Использовать `pg_locks`, `pg_blocking_pids`, `pg_stat_activity`, включить `log_lock_waits`. Анализировать `wait_event`, `state`, длительность транзакций.
12. **Зачем нужны `SELECT ... FOR UPDATE SKIP LOCKED`?**
    - Для конкурентных очередей: процесс получает свободную задачу без ожидания, пропуская заблокированные строки.

## 5. Эксплуатация
13. **Какие подходы к резервному копированию существуют?**
    - Логические (`pg_dump`, `pg_restore`), физические (`pg_basebackup`, snapshots), инкрементальные решения (`pg_probackup`, `wal-g`), PITR.
14. **Как настроить мониторинг PostgreSQL?**
    - Использовать `pg_stat_*`, `pg_stat_statements`, `auto_explain`, Prometheus-экспортёр, Grafana-дэшборды, алерты по задержкам репликации и заполнению диска.
15. **Чем полезно расширение `pg_stat_statements`?**
    - Сохраняет агрегированную статистику по запросам: количество вызовов, среднее/общее время, дисперсия, блокировки. Помогает при тюнинге и поиске «тяжёлых» запросов.

## 6. Дополнительные темы
16. **Что такое `hot standby feedback`?**
    - Настройка (`hot_standby_feedback=on`) позволяет реплике сообщать мастеру об активных снимках, предотвращая удаление версий, которые ещё нужны реплике. Может увеличивать bloat.
17. **Как реализовать row-level security?**
    - `ALTER TABLE ... ENABLE ROW LEVEL SECURITY; CREATE POLICY ... USING (условие);` — политики фильтруют строки для ролей.
18. **Какие проблемы могут возникнуть при длительных транзакциях?**
    - Рост `pg_wal`, задержка репликации, блокировка `VACUUM FREEZE`, удержание блокировок и снимков.
19. **Как обновить PostgreSQL без длительного простоя?**
    - Создать новый кластер, настроить логическую репликацию, переключить трафик после синхронизации; либо использовать `pg_upgrade --link` с минимальным временем простоя.
20. **Что такое `fillfactor` и когда его настраивать?**
    - Процент заполнения страниц при вставке. Снижайте `fillfactor` на таблицах с частыми обновлениями, чтобы оставлять место для HOT-обновлений и уменьшить bloat.

Этот список вопросов покрывает ключевые темы: архитектуру, типы данных, оптимизацию, транзакции и эксплуатацию. Ответы помогают структурировать подготовку к собеседованию и выявить пробелы в знаниях.
